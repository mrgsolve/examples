    library(mrgsolve)
    library(minqa)
    library(methods)
    library(magrittr) 
    library(dplyr)
    source("functions.R")

The model

    mod<- mread("denpk", "model")
    param(mod)

    ## 
    ##  Model parameters (N=5):
    ##  name  value . name    value
    ##  DENCL 2.75  | DENVMAX 3110 
    ##  DENKM 188   | DENVP   1324 
    ##  DENVC 2340  | .       .

    init(mod)

    ## 
    ##  Model initial conditions (N=3):
    ##  name          value . name        value
    ##  DENCENT (2)   0     | DENSC (1)   0    
    ##  DENPER (3)    0     | . ...       .

    see(mod)

    ## 
    ## Model file:  denpk.cpp 
    ##  $GLOBAL
    ##  #define DMABCP (DENCENT/DENVC)
    ##  #define DENMOL (DENCENT/DENVC/150000)*1000*1000
    ##  #define DENCLNL (DENVMAX/(DENKM+DMABCP))
    ##  
    ##  $PARAM
    ##  DENVMAX = 3110
    ##  DENKM = 188
    ##  DENVC = 2340
    ##  DENVP = 1324  
    ##  DENCL = 2.75
    ##  
    ##  $FIXED
    ##  DENQ = 18.67 
    ##  DENKA = 0.00592
    ##  DENF = 0.72
    ##  
    ##  $CMT DENSC DENCENT DENPER
    ##  
    ##  $MAIN F_DENSC=DENF;
    ##  
    ##  $ODE
    ##  dxdt_DENSC =  -DENKA*DENSC;
    ##  dxdt_DENCENT = DENKA*DENSC + DENQ*DENPER/DENVP - (DENQ+DENCL+DENCLNL)*DENCENT/DENVC ;
    ##  dxdt_DENPER =  DENQ*DENCENT/DENVC - DENQ*DENPER/DENVP;
    ##  
    ##  $SIGMA 0.0449
    ##  
    ##  $TABLE
    ##  double DENCP   = (DENCENT/DENVC/150000)*1000;
    ##  double DENmMOL = DENCP*(1+EPS(1)) ;
    ##  
    ##   
    ##  $CAPTURE DENmMOL DENCP

Function returning the objective function

    ols <- function(par,d,n,pred=FALSE) {
      
      par <- setNames(lapply(par,exp),n)
      
      out<- 
        mod %>% 
        param(par) %>%
        data_set(d) %>% 
        Req(DENCP) %>% 
        drop.re %>%
        mrgsim(obsonly=TRUE) %>%
        filter(!is.na(DENCP) & time!=0)
      
      if(pred) return(out)
      
      d %<>% filter(time > 0 & evid==0)
      
      log.yhat <- log(out$DENCP)
      log.y    <- log(d$DENmMOL)
      
      return(sum((log.y - log.yhat)^2))
      
    }

Simulate an abbreviated data set

    set.seed(101)
    d <- sim(1,mod,template(mod)) %>% filter(time <= 4032)

Initial estimates

    theta <- log(c(DENCL=6, DENVC=3000, DENVMAX=1000, DENVP=3000))

Fit with `minqa::newuoa`

    fit1 <- newuoa(par=theta, fn=ols, d=d, n=names(theta), control=list(iprint=5))

    ## npt = 6 , n =  4 
    ## rhobeg =  0.95 , rhoend =  9.5e-07 
    ## start par. =  1.791759 8.006368 6.907755 8.006368 fn =  441.2809 
    ##   5:     684.50600:  1.79176  8.00637  6.90776  8.95637
    ## rho:    0.095 eval:   7 fn:      188.258 par: 1.79176  8.00637  7.85776  8.00637 
    ##  10:     237.29501:  1.76569  8.03149  7.63325  7.93786
    ##  15:     171.46155:  1.64119  7.79303  7.65819  7.79615
    ##  20:     150.71589:  1.76945  8.07767  7.86747  7.74354
    ##  25:     86.945611:  1.60821  8.12490  8.19546  7.86340
    ##  30:     69.433925:  1.52486  8.01026  8.01406  7.56847
    ##  35:     63.421542:  1.36979  7.93416  7.92104  7.49475
    ##  40:     32.141926:  1.33271  7.94012  8.11436  7.56576
    ##  45:     20.367593:  1.20273  7.97731  8.15876  7.49432
    ##  50:     25.393680:  1.17382  8.06164  8.37485  7.45786
    ## rho:   0.0095 eval:  53 fn:      15.4694 par: 1.17615  8.09702  8.35351  7.54710 
    ##  55:     14.000724:  1.14113  8.06870  8.29802  7.49977
    ##  60:     12.037135:  1.16466  8.01404  8.27584  7.49728
    ##  65:     9.7533175:  1.13063  7.98221  8.24324  7.43758
    ##  70:     8.0698910:  1.10327  7.92805  8.21410  7.41457
    ##  75:     6.9967891:  1.07561  7.89455  8.17340  7.36248
    ##  80:     6.3755255:  1.04362  7.84986  8.10525  7.27262
    ##  85:     5.6841615:  1.05859  7.83299  8.12690  7.30420
    ##  90:     5.2698714:  1.03169  7.77879  8.07679  7.26297
    ##  95:     5.1529083:  1.01935  7.76566  8.06834  7.24784
    ## rho:  0.00095 eval:  98 fn:      5.07638 par: 1.02188  7.77275  8.08208  7.25579 
    ## 100:     5.0391675:  1.01843  7.76488  8.07626  7.24669
    ## 105:     5.0085267:  1.01054  7.75298  8.06877  7.23640
    ## 110:     5.0042177:  1.00733  7.74835  8.06418  7.23125
    ## 115:     5.0028096:  1.00430  7.74538  8.06346  7.23020
    ## rho:  9.5e-05 eval: 119 fn:      5.00195 par: 1.00570  7.74587  8.06391  7.23098 
    ## 120:     5.0019204:  1.00572  7.74605  8.06411  7.23119
    ## 125:     5.0005339:  1.00491  7.74511  8.06409  7.23186
    ## 130:     4.9987907:  1.00190  7.74136  8.06422  7.23326
    ## 135:     4.9962721:  1.00351  7.74212  8.06510  7.23477
    ## 140:     4.9942913:  1.00289  7.74174  8.06630  7.23776
    ## 145:     4.9932368:  1.00213  7.74046  8.06667  7.23871
    ## 150:     4.9873188:  1.00475  7.74064  8.06775  7.24316
    ## 155:     4.9940506:  1.00509  7.74074  8.07204  7.25609
    ## 160:     4.9794380:  1.00062  7.72958  8.07651  7.27003
    ## 165:     4.9662557:  1.00412  7.72976  8.07829  7.27169
    ## 170:     4.9646380:  1.00304  7.72772  8.07743  7.27169
    ## 175:     4.9628430:  1.00133  7.72370  8.07863  7.27734
    ## 180:     4.9610478:  1.00238  7.72350  8.07901  7.27775
    ## 185:     4.9591185:  1.00300  7.72061  8.07990  7.28370
    ## 190:     4.9581217:  1.00279  7.71881  8.08048  7.28564
    ## 195:     4.9579061:  1.00229  7.71847  8.08002  7.28457
    ## 200:     4.9575248:  1.00204  7.71676  8.08059  7.28775
    ## 205:     4.9571595:  1.00138  7.71623  8.08049  7.28689
    ## 210:     4.9569750:  1.00078  7.71521  8.08042  7.28718
    ## 215:     4.9567746:  1.00131  7.71495  8.08034  7.28797
    ## 220:     4.9564020:  1.00087  7.71321  8.08032  7.28909
    ## 225:     4.9562714: 0.999844  7.71049  8.08044  7.29112
    ## 230:     4.9561811:  1.00030  7.71093  8.08051  7.29089
    ## 235:     4.9561645:  1.00029  7.71068  8.08047  7.29114
    ## 240:     4.9561561:  1.00022  7.71040  8.08040  7.29124
    ## 245:     4.9561564:  1.00020  7.71028  8.08040  7.29138
    ## rho:  9.5e-06 eval: 246 fn:      4.95615 par: 1.00025  7.71031  8.08039  7.29133 
    ## 250:     4.9561532:  1.00026  7.71033  8.08038  7.29130
    ## 255:     4.9561520:  1.00026  7.71034  8.08032  7.29119
    ## 260:     4.9561518:  1.00025  7.71031  8.08032  7.29121
    ## 265:     4.9561525:  1.00020  7.71021  8.08028  7.29126
    ## 270:     4.9561506:  1.00020  7.71016  8.08029  7.29125
    ## 275:     4.9561500:  1.00020  7.71011  8.08024  7.29121
    ## 280:     4.9561498:  1.00019  7.71009  8.08020  7.29115
    ## 285:     4.9561497:  1.00019  7.71010  8.08018  7.29112
    ## 290:     4.9561499:  1.00020  7.71012  8.08019  7.29111
    ## 295:     4.9561498:  1.00020  7.71014  8.08016  7.29106
    ## 300:     4.9561497:  1.00020  7.71015  8.08017  7.29107
    ## rho:  9.5e-07 eval: 301 fn:      4.95615 par: 1.00020  7.71015  8.08017  7.29106 
    ## 305:     4.9561497:  1.00020  7.71015  8.08017  7.29106
    ## At return
    ## eval: 308 fn:      4.9561497 par:  1.00020  7.71015  8.08017  7.29107

Fit with `stats:: optim`

    contr <- list(trace=2, parscale=theta, maxit=1500)
    fit2 <- optim(par=theta, fn=ols, d=d, n=names(theta), control=contr)

    ##   Nelder-Mead direct search function minimizer
    ## function value for initial parameters = 441.280890
    ##   Scaled convergence tolerance is 6.5756e-06
    ## Stepsize computed as 0.100000
    ## BUILD              5 669.310842 258.427749
    ## LO-REDUCTION       7 654.495219 258.427749
    ## LO-REDUCTION       9 441.280890 258.427749
    ## LO-REDUCTION      11 391.123476 258.427749
    ## REFLECTION        13 384.180856 201.112818
    ## EXTENSION         15 277.474337 123.870490
    ## EXTENSION         17 271.725313 97.008539
    ## HI-REDUCTION      19 258.427749 97.008539
    ## HI-REDUCTION      21 201.112818 97.008539
    ## HI-REDUCTION      23 197.583331 97.008539
    ## LO-REDUCTION      25 188.054322 97.008539
    ## LO-REDUCTION      27 160.218718 78.710380
    ## LO-REDUCTION      29 135.857344 78.710380
    ## LO-REDUCTION      31 123.870490 76.869808
    ## REFLECTION        33 108.120788 74.582052
    ## REFLECTION        35 97.008539 57.791598
    ## LO-REDUCTION      37 78.710380 57.791598
    ## REFLECTION        39 76.869808 57.561939
    ## EXTENSION         41 74.582052 43.663768
    ## LO-REDUCTION      43 70.292327 43.663768
    ## REFLECTION        45 57.791598 36.509648
    ## HI-REDUCTION      47 57.561939 36.509648
    ## REFLECTION        49 50.314802 31.904541
    ## LO-REDUCTION      51 44.675955 31.904541
    ## LO-REDUCTION      53 43.663768 31.904541
    ## REFLECTION        55 36.509648 21.569554
    ## LO-REDUCTION      57 34.320374 21.569554
    ## LO-REDUCTION      59 33.108595 21.569554
    ## HI-REDUCTION      61 31.904541 21.569554
    ## LO-REDUCTION      63 27.105286 21.569554
    ## LO-REDUCTION      65 26.575085 21.569554
    ## EXTENSION         67 25.817218 18.522948
    ## EXTENSION         69 23.544033 14.930361
    ## REFLECTION        71 21.786703 13.974377
    ## LO-REDUCTION      73 21.569554 13.974377
    ## REFLECTION        75 18.522948 10.657409
    ## REFLECTION        77 14.930361 10.169834
    ## HI-REDUCTION      79 14.313388 10.169834
    ## REFLECTION        81 13.974377 9.189660
    ## REFLECTION        83 12.124208 8.404343
    ## REFLECTION        85 10.657409 6.590378
    ## HI-REDUCTION      87 10.169834 6.590378
    ## LO-REDUCTION      89 9.189660 6.590378
    ## LO-REDUCTION      91 8.477642 6.590378
    ## REFLECTION        93 8.404343 6.194436
    ## LO-REDUCTION      95 7.209665 6.194436
    ## LO-REDUCTION      97 6.817628 6.194436
    ## LO-REDUCTION      99 6.809180 6.194436
    ## REFLECTION       101 6.590378 6.151953
    ## REFLECTION       103 6.313408 6.089928
    ## HI-REDUCTION     105 6.220624 6.061520
    ## LO-REDUCTION     107 6.194436 6.032231
    ## REFLECTION       109 6.151953 5.921909
    ## HI-REDUCTION     111 6.089928 5.921909
    ## LO-REDUCTION     113 6.061520 5.921909
    ## HI-REDUCTION     115 6.032231 5.921909
    ## LO-REDUCTION     117 6.009224 5.921909
    ## LO-REDUCTION     119 5.977949 5.921909
    ## LO-REDUCTION     121 5.970795 5.921909
    ## REFLECTION       123 5.953659 5.916533
    ## LO-REDUCTION     125 5.941801 5.916533
    ## LO-REDUCTION     127 5.930254 5.916533
    ## HI-REDUCTION     129 5.921909 5.916533
    ## HI-REDUCTION     131 5.920158 5.916533
    ## HI-REDUCTION     133 5.919246 5.916533
    ## REFLECTION       135 5.919102 5.915913
    ## LO-REDUCTION     137 5.917837 5.915649
    ## REFLECTION       139 5.917310 5.915118
    ## REFLECTION       141 5.916533 5.913553
    ## LO-REDUCTION     143 5.915913 5.913553
    ## HI-REDUCTION     145 5.915649 5.913553
    ## LO-REDUCTION     147 5.915118 5.913553
    ## REFLECTION       149 5.914291 5.913168
    ## REFLECTION       151 5.914099 5.912720
    ## EXTENSION        153 5.913890 5.911724
    ## LO-REDUCTION     155 5.913553 5.911724
    ## LO-REDUCTION     157 5.913168 5.911724
    ## REFLECTION       159 5.912720 5.911010
    ## LO-REDUCTION     161 5.911943 5.911010
    ## LO-REDUCTION     163 5.911790 5.911010
    ## LO-REDUCTION     165 5.911724 5.911010
    ## REFLECTION       167 5.911161 5.910495
    ## LO-REDUCTION     169 5.911114 5.910495
    ## HI-REDUCTION     171 5.911038 5.910495
    ## LO-REDUCTION     173 5.911010 5.910495
    ## EXTENSION        175 5.910771 5.910307
    ## EXTENSION        177 5.910651 5.910207
    ## EXTENSION        179 5.910631 5.909537
    ## EXTENSION        181 5.910495 5.909188
    ## EXTENSION        183 5.910307 5.908223
    ## LO-REDUCTION     185 5.910207 5.908223
    ## LO-REDUCTION     187 5.909537 5.908223
    ## REFLECTION       189 5.909188 5.908094
    ## EXTENSION        191 5.908751 5.906594
    ## LO-REDUCTION     193 5.908256 5.906594
    ## LO-REDUCTION     195 5.908223 5.906594
    ## LO-REDUCTION     197 5.908094 5.906594
    ## EXTENSION        199 5.907841 5.905433
    ## LO-REDUCTION     201 5.907172 5.905433
    ## EXTENSION        203 5.906840 5.904430
    ## LO-REDUCTION     205 5.906594 5.904430
    ## EXTENSION        207 5.905843 5.903934
    ## EXTENSION        209 5.905433 5.902480
    ## LO-REDUCTION     211 5.905188 5.902480
    ## EXTENSION        213 5.904430 5.901525
    ## LO-REDUCTION     215 5.903934 5.901525
    ## EXTENSION        217 5.903538 5.901230
    ## REFLECTION       219 5.902792 5.901047
    ## EXTENSION        221 5.902480 5.899654
    ## LO-REDUCTION     223 5.901525 5.899654
    ## HI-REDUCTION     225 5.901230 5.899654
    ## EXTENSION        227 5.901047 5.898562
    ## LO-REDUCTION     229 5.900769 5.898562
    ## EXTENSION        231 5.900688 5.897303
    ## EXTENSION        233 5.899654 5.896862
    ## EXTENSION        235 5.898856 5.892181
    ## LO-REDUCTION     237 5.898562 5.892181
    ## LO-REDUCTION     239 5.897303 5.892181
    ## REFLECTION       241 5.896862 5.892101
    ## EXTENSION        243 5.893516 5.885917
    ## LO-REDUCTION     245 5.893003 5.885917
    ## EXTENSION        247 5.892181 5.881670
    ## EXTENSION        249 5.892101 5.878401
    ## LO-REDUCTION     251 5.888121 5.878401
    ## EXTENSION        253 5.885917 5.867211
    ## LO-REDUCTION     255 5.881670 5.867211
    ## LO-REDUCTION     257 5.879062 5.867211
    ## LO-REDUCTION     259 5.878401 5.867211
    ## EXTENSION        261 5.870968 5.859918
    ## EXTENSION        263 5.870250 5.854261
    ## EXTENSION        265 5.868051 5.847458
    ## EXTENSION        267 5.867211 5.846004
    ## LO-REDUCTION     269 5.859918 5.846004
    ## EXTENSION        271 5.854261 5.822479
    ## LO-REDUCTION     273 5.848475 5.822479
    ## LO-REDUCTION     275 5.847458 5.822479
    ## LO-REDUCTION     277 5.846004 5.822479
    ## EXTENSION        279 5.838970 5.808738
    ## EXTENSION        281 5.825774 5.778553
    ## LO-REDUCTION     283 5.825595 5.778553
    ## LO-REDUCTION     285 5.822479 5.778553
    ## LO-REDUCTION     287 5.808738 5.778553
    ## EXTENSION        289 5.805272 5.762416
    ## EXTENSION        291 5.795240 5.748092
    ## EXTENSION        293 5.785359 5.705071
    ## EXTENSION        295 5.778553 5.669780
    ## LO-REDUCTION     297 5.762416 5.669780
    ## EXTENSION        299 5.748092 5.625107
    ## EXTENSION        301 5.707472 5.553729
    ## EXTENSION        303 5.705071 5.476251
    ## LO-REDUCTION     305 5.669780 5.476251
    ## EXTENSION        307 5.625107 5.404649
    ## EXTENSION        309 5.553729 5.327450
    ## REFLECTION       311 5.487928 5.301486
    ## REFLECTION       313 5.476251 5.252361
    ## HI-REDUCTION     315 5.404649 5.252361
    ## REFLECTION       317 5.342269 5.229093
    ## LO-REDUCTION     319 5.327450 5.229093
    ## EXTENSION        321 5.301486 5.187097
    ## REFLECTION       323 5.275542 5.183946
    ## EXTENSION        325 5.252361 5.076600
    ## EXTENSION        327 5.229093 4.999222
    ## LO-REDUCTION     329 5.187097 4.999222
    ## LO-REDUCTION     331 5.183946 4.999222
    ## REFLECTION       333 5.076600 4.978835
    ## REFLECTION       335 5.047507 4.978488
    ## REFLECTION       337 5.031680 4.977970
    ## REFLECTION       339 4.999222 4.973053
    ## LO-REDUCTION     341 4.978835 4.962670
    ## HI-REDUCTION     343 4.978488 4.958978
    ## HI-REDUCTION     345 4.977970 4.958978
    ## HI-REDUCTION     347 4.973053 4.958978
    ## LO-REDUCTION     349 4.962670 4.957754
    ## HI-REDUCTION     351 4.961879 4.957665
    ## LO-REDUCTION     353 4.961699 4.957665
    ## LO-REDUCTION     355 4.958978 4.957665
    ## LO-REDUCTION     357 4.957824 4.956868
    ## REFLECTION       359 4.957754 4.956771
    ## HI-REDUCTION     361 4.957746 4.956479
    ## HI-REDUCTION     363 4.957665 4.956390
    ## LO-REDUCTION     365 4.956868 4.956390
    ## HI-REDUCTION     367 4.956771 4.956349
    ## HI-REDUCTION     369 4.956566 4.956325
    ## LO-REDUCTION     371 4.956479 4.956250
    ## LO-REDUCTION     373 4.956390 4.956218
    ## HI-REDUCTION     375 4.956349 4.956214
    ## HI-REDUCTION     377 4.956325 4.956214
    ## HI-REDUCTION     379 4.956250 4.956211
    ## REFLECTION       381 4.956224 4.956163
    ## HI-REDUCTION     383 4.956218 4.956163
    ## LO-REDUCTION     385 4.956214 4.956163
    ## HI-REDUCTION     387 4.956211 4.956163
    ## LO-REDUCTION     389 4.956185 4.956163
    ## HI-REDUCTION     391 4.956183 4.956163
    ## LO-REDUCTION     393 4.956182 4.956163
    ## EXTENSION        395 4.956174 4.956151
    ## LO-REDUCTION     397 4.956172 4.956151
    ## LO-REDUCTION     399 4.956172 4.956151
    ## LO-REDUCTION     401 4.956163 4.956151
    ## LO-REDUCTION     403 4.956161 4.956151
    ## Exiting from Nelder Mead minimizer
    ##     405 function evaluations used

Results

    exp(fit1$par)

    ## [1]    2.718822 2230.867375 3229.775513 1467.132734

    exp(fit2$par)

    ##       DENCL       DENVC     DENVMAX       DENVP 
    ##    2.719009 2231.149741 3229.548559 1466.871924

    as.numeric(param(mod))[names(theta)]

    ##   DENCL   DENVC DENVMAX   DENVP 
    ##    2.75 2340.00 3110.00 1324.00
