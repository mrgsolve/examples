    library(mrgsolve)
    library(minqa)
    library(methods)
    library(magrittr) 
    library(dplyr)
    source("functions.R")

The model

    mod<- mread("denpk", "model")
    param(mod)

    ## 
    ##  Model parameters (N=5):
    ##  name  value . name    value
    ##  DENCL 2.75  | DENVMAX 3110 
    ##  DENKM 188   | DENVP   1324 
    ##  DENVC 2340  | .       .

    init(mod)

    ## 
    ##  Model initial conditions (N=3):
    ##  name          value . name        value
    ##  DENCENT (2)   0     | DENSC (1)   0    
    ##  DENPER (3)    0     | . ...       .

    see(mod)

    ## 
    ## Model file:  denpk.cpp 
    ## $GLOBAL
    ## #define DMABCP (DENCENT/DENVC)
    ## #define DENMOL (DENCENT/DENVC/150000)*1000*1000
    ## #define DENCLNL (DENVMAX/(DENKM+DMABCP))
    ## 
    ## $PARAM
    ## DENVMAX = 3110
    ## DENKM = 188
    ## DENVC = 2340
    ## DENVP = 1324  
    ## DENCL = 2.75
    ## 
    ## $FIXED
    ## DENQ = 18.67 
    ## DENKA = 0.00592
    ## DENF = 0.72
    ## 
    ## $CMT DENSC DENCENT DENPER
    ## 
    ## $MAIN F_DENSC=DENF;
    ## 
    ## $ODE
    ## dxdt_DENSC =  -DENKA*DENSC;
    ## dxdt_DENCENT = DENKA*DENSC + DENQ*DENPER/DENVP - (DENQ+DENCL+DENCLNL)*DENCENT/DENVC ;
    ## dxdt_DENPER =  DENQ*DENCENT/DENVC - DENQ*DENPER/DENVP;
    ## 
    ## $SIGMA 0.0449
    ## 
    ## $TABLE
    ## double DENCP   = (DENCENT/DENVC/150000)*1000;
    ## double DENmMOL = DENCP*(1+EPS(1)) ;
    ## 
    ##  
    ## $CAPTURE DENmMOL DENCP

Function returning the objective function

    ols <- function(par,d,n,pred=FALSE) {
      
      par <- setNames(lapply(par,exp),n)
      
      out<- 
        mod %>% 
        param(par) %>%
        data_set(d) %>% 
        Req(DENCP) %>% 
        drop.re %>%
        mrgsim(obsonly=TRUE) %>%
        filter(!is.na(DENCP) & time!=0)
      
      if(pred) return(out)
      
      d %<>% filter(time > 0 & evid==0)
      
      log.yhat <- log(out$DENCP)
      log.y    <- log(d$DENmMOL)
      
      return(sum((log.y - log.yhat)^2))
      
    }

Simulate an abbreviated data set

    set.seed(101)
    d <- sim(1,mod) %>% filter(time <= 4032)
    head(as.data.frame(d))

    ##   ID time evid   amt cmt   ii addl  DENmMOL
    ## 1  1    0    0 0e+00   0    0    0 0.000000
    ## 2  1    0    1 1e+07   1 4032    3 0.000000
    ## 3  1   12    0 0e+00   0    0    0 1.655885
    ## 4  1   34    0 0e+00   0    0    0 3.758968
    ## 5  1  168    0 0e+00   0    0    0 5.909730
    ## 6  1  336    0 0e+00   0    0    0 6.741199

Initial estimates

    theta <- log(c(DENCL=6, DENVC=3000, DENVMAX=1000, DENVP=3000))

Fit with `minqa::newuoa`

    fit1 <- newuoa(par=theta, fn=ols, d=d, n=names(theta), control=list(iprint=5))

    ## npt = 6 , n =  4 
    ## rhobeg =  0.95 , rhoend =  9.5e-07 
    ## start par. =  1.791759 8.006368 6.907755 8.006368 fn =  336.6404 
    ##   5:     514.38231:  1.79176  8.00637  6.90776  8.95637
    ## rho:    0.095 eval:   7 fn:      145.249 par: 1.79176  8.00637  7.85776  8.00637 
    ##  10:     193.06904:  1.75874  8.00340  7.62270  7.99880
    ##  15:     111.21377:  1.71727  8.48007  8.38720  8.21284
    ##  20:     89.413872:  1.68977  8.43941  8.46852  8.18232
    ##  25:     65.180377:  1.54077  8.72627  8.42753  7.70059
    ##  30:     48.442411:  1.61517  8.68841  8.50585  7.64393
    ## rho:   0.0095 eval:  30 fn:      48.4424 par: 1.61517  8.68841  8.50585  7.64393 
    ##  35:     24.685919:  1.41549  8.53631  8.40918  7.40648
    ##  40:     5.7819323:  1.16830  8.16113  8.16468  7.03439
    ##  45:     5.4982511:  1.15972  8.15035  8.15850  7.02570
    ##  50:     4.6533566:  1.10975  8.10114  8.11071  6.96317
    ##  55:     3.9174983:  1.10172  8.06907  8.10124  6.92997
    ##  60:     3.7424167:  1.04721  8.03161  8.06323  6.85357
    ##  65:     3.4147804:  1.03936  7.99789  8.05433  6.83251
    ##  70:     3.1036452:  1.03650  7.96230  8.01396  6.81423
    ##  75:     3.4528881:  1.02568  7.95487  7.99649  6.80711
    ## rho:  0.00095 eval:  78 fn:      3.06108 par: 1.03389  7.94856  8.00697  6.81997 
    ##  80:     3.0640509:  1.03410  7.94895  8.00606  6.81986
    ##  85:     3.0394262:  1.03525  7.93954  8.00156  6.82316
    ##  90:     3.0307984:  1.03508  7.93331  7.99596  6.82431
    ##  95:     3.0257069:  1.03492  7.93049  7.99476  6.82747
    ## 100:     3.0201777:  1.03164  7.92810  7.99470  6.82556
    ## 105:     3.0120395:  1.02746  7.92007  7.99050  6.82500
    ## 110:     3.0105787:  1.02667  7.91660  7.98882  6.82463
    ## 115:     3.0077669:  1.02476  7.91240  7.98691  6.82500
    ## 120:     3.0059584:  1.02250  7.91032  7.98634  6.82527
    ## 125:     3.0008612:  1.02238  7.90882  7.98806  6.83020
    ## 130:     2.9955423:  1.02090  7.90873  7.98929  6.83395
    ## 135:     2.9920281:  1.02122  7.90643  7.98702  6.83514
    ## 140:     2.9759481:  1.01981  7.89402  7.98285  6.84574
    ## 145:     2.9472876:  1.01093  7.86618  7.97543  6.87104
    ## 150:     2.9488699:  1.01204  7.86092  7.97438  6.87595
    ## 155:     2.9393485:  1.00548  7.84844  7.97303  6.88656
    ## 160:     2.9289828:  1.00473  7.84979  7.97374  6.89018
    ## 165:     2.8877945: 0.991169  7.81013  7.97353  6.94684
    ## 170:     2.8748618: 0.994992  7.81654  7.97662  6.94126
    ## 175:     2.7558947:  1.00357  7.82254  8.01646  7.04661
    ## 180:     2.7300721:  1.00492  7.82055  8.01909  7.04574
    ## 185:     2.7305199:  1.00257  7.81539  8.01506  7.04166
    ## 190:     2.7112380:  1.00505  7.80952  8.01246  7.05148
    ## 195:     2.6960044:  1.00489  7.79196  8.00821  7.06723
    ## 200:     2.6949658:  1.00464  7.79657  8.01103  7.06627
    ## 205:     2.6943879:  1.00487  7.80021  8.01415  7.07039
    ## 210:     2.6818892:  1.00363  7.78858  8.02069  7.10349
    ## 215:     2.6736630:  1.00359  7.78953  8.02021  7.09628
    ## 220:     2.6644741:  1.00286  7.78358  8.02378  7.11092
    ## 225:     2.6619022:  1.00302  7.78178  8.02406  7.11193
    ## 230:     2.6547556: 0.997030  7.76242  8.01904  7.12363
    ## 235:     2.6513839: 0.997964  7.76186  8.01986  7.12403
    ## 240:     2.6610092: 0.994243  7.75215  8.01864  7.13677
    ## 245:     2.6443247: 0.998160  7.75528  8.02373  7.13989
    ## 250:     2.6424539: 0.996761  7.74867  8.02271  7.14622
    ## 255:     2.6413273: 0.995588  7.74466  8.02332  7.15207
    ## 260:     2.6401207: 0.995118  7.74420  8.02360  7.15022
    ## 265:     2.6389065: 0.995051  7.74460  8.02533  7.15307
    ## 270:     2.6377497: 0.995327  7.74279  8.02664  7.15926
    ## 275:     2.6364795: 0.994922  7.74192  8.02934  7.16490
    ## 280:     2.6358032: 0.994763  7.73966  8.02947  7.16688
    ## 285:     2.6353537: 0.994119  7.73604  8.02993  7.17238
    ## 290:     2.6352101: 0.993780  7.73693  8.03084  7.17100
    ## 295:     2.6347187: 0.992340  7.73311  8.03029  7.17334
    ## rho:  9.5e-05 eval: 299 fn:      2.63462 par:0.992652  7.73284  8.03008  7.17385 
    ## 300:     2.6346354: 0.992516  7.73254  8.02986  7.17360
    ## 305:     2.6345774: 0.992487  7.73230  8.03017  7.17423
    ## 310:     2.6345434: 0.992484  7.73198  8.03004  7.17452
    ## 315:     2.6345837: 0.992573  7.73237  8.03055  7.17567
    ## 320:     2.6344214: 0.992256  7.73124  8.03054  7.17606
    ## 325:     2.6343651: 0.992209  7.73093  8.03084  7.17700
    ## 330:     2.6343221: 0.991720  7.72931  8.03049  7.17772
    ## 335:     2.6342711: 0.991927  7.72944  8.03080  7.17833
    ## 340:     2.6342292: 0.991640  7.72857  8.03137  7.18028
    ## 345:     2.6341892: 0.991859  7.72854  8.03135  7.18029
    ## 350:     2.6341824: 0.991930  7.72854  8.03141  7.18053
    ## 355:     2.6341723: 0.991836  7.72801  8.03173  7.18181
    ## 360:     2.6341577: 0.991868  7.72792  8.03164  7.18161
    ## 365:     2.6341503: 0.991693  7.72734  8.03177  7.18239
    ## 370:     2.6341453: 0.991675  7.72717  8.03175  7.18246
    ## 375:     2.6341658: 0.991560  7.72698  8.03176  7.18280
    ## rho:  9.5e-06 eval: 376 fn:      2.63414 par:0.991605  7.72692  8.03178  7.18275 
    ## 380:     2.6341429: 0.991639  7.72690  8.03177  7.18274
    ## 385:     2.6341422: 0.991616  7.72677  8.03179  7.18295
    ## 390:     2.6341419: 0.991603  7.72672  8.03180  7.18299
    ## rho:  9.5e-07 eval: 394 fn:      2.63414 par:0.991610  7.72671  8.03179  7.18298 
    ## 395:     2.6341418: 0.991610  7.72671  8.03179  7.18298
    ## 400:     2.6341418: 0.991590  7.72664  8.03177  7.18300
    ## 405:     2.6341417: 0.991585  7.72663  8.03178  7.18303
    ## 410:     2.6341417: 0.991590  7.72663  8.03178  7.18304
    ## 415:     2.6341417: 0.991582  7.72659  8.03178  7.18307
    ## 420:     2.6341417: 0.991588  7.72661  8.03179  7.18307
    ## At return
    ## eval: 423 fn:      2.6341417 par: 0.991588  7.72661  8.03179  7.18307

Fit with `stats:: optim`

    contr <- list(trace=2, parscale=theta, maxit=1500)
    fit2 <- optim(par=theta, fn=ols, d=d, n=names(theta), control=contr)

    ##   Nelder-Mead direct search function minimizer
    ## function value for initial parameters = 336.640378
    ##   Scaled convergence tolerance is 5.01633e-06
    ## Stepsize computed as 0.100000
    ## BUILD              5 492.460075 197.671358
    ## LO-REDUCTION       7 487.951555 197.671358
    ## LO-REDUCTION       9 336.640378 197.671358
    ## LO-REDUCTION      11 302.164569 197.671358
    ## REFLECTION        13 219.195240 169.070531
    ## REFLECTION        15 217.525637 157.803603
    ## REFLECTION        17 197.909581 104.963789
    ## REFLECTION        19 197.671358 94.198246
    ## HI-REDUCTION      21 169.070531 94.198246
    ## HI-REDUCTION      23 157.803603 94.198246
    ## EXTENSION         25 138.966491 49.309450
    ## LO-REDUCTION      27 133.640677 49.309450
    ## HI-REDUCTION      29 104.963789 49.309450
    ## EXTENSION         31 94.198246 30.643839
    ## HI-REDUCTION      33 90.399924 30.643839
    ## LO-REDUCTION      35 63.785301 30.643839
    ## LO-REDUCTION      37 56.296734 30.643839
    ## LO-REDUCTION      39 49.309450 30.643839
    ## HI-REDUCTION      41 39.244355 30.643839
    ## LO-REDUCTION      43 36.934199 30.643839
    ## LO-REDUCTION      45 36.653418 30.643839
    ## HI-REDUCTION      47 36.297663 30.643839
    ## REFLECTION        49 32.793597 30.237291
    ## REFLECTION        51 32.365864 29.460508
    ## EXTENSION         53 31.405132 26.945394
    ## HI-REDUCTION      55 30.643839 26.945394
    ## LO-REDUCTION      57 30.237291 26.945394
    ## REFLECTION        59 29.460508 26.804839
    ## EXTENSION         61 28.833169 24.983685
    ## HI-REDUCTION      63 27.282647 24.983685
    ## LO-REDUCTION      65 26.945394 24.983685
    ## LO-REDUCTION      67 26.870055 24.983685
    ## REFLECTION        69 26.804839 24.774887
    ## LO-REDUCTION      71 26.092678 24.774887
    ## EXTENSION         73 25.211810 22.097415
    ## HI-REDUCTION      75 24.983685 22.097415
    ## LO-REDUCTION      77 24.844167 22.097415
    ## LO-REDUCTION      79 24.774887 22.097415
    ## EXTENSION         81 24.227081 20.308690
    ## LO-REDUCTION      83 23.622287 20.308690
    ## EXTENSION         85 23.031401 17.878592
    ## EXTENSION         87 22.097415 14.353051
    ## LO-REDUCTION      89 20.624045 14.353051
    ## EXTENSION         91 20.308690 11.489509
    ## EXTENSION         93 17.878592 7.543872
    ## EXTENSION         95 15.379529 4.850681
    ## LO-REDUCTION      97 14.353051 4.850681
    ## LO-REDUCTION      99 11.489509 4.850681
    ## REFLECTION       101 7.543872 3.863307
    ## HI-REDUCTION     103 5.894916 3.863307
    ## LO-REDUCTION     105 5.493610 3.863307
    ## EXTENSION        107 5.094910 2.855839
    ## HI-REDUCTION     109 4.850681 2.855839
    ## LO-REDUCTION     111 3.952006 2.855839
    ## LO-REDUCTION     113 3.863307 2.855839
    ## LO-REDUCTION     115 3.789165 2.855839
    ## HI-REDUCTION     117 3.430343 2.855839
    ## LO-REDUCTION     119 3.155497 2.855839
    ## HI-REDUCTION     121 3.145011 2.855839
    ## REFLECTION       123 3.091925 2.845391
    ## REFLECTION       125 2.981005 2.727985
    ## LO-REDUCTION     127 2.890062 2.727985
    ## REFLECTION       129 2.855839 2.693434
    ## LO-REDUCTION     131 2.845391 2.693434
    ## LO-REDUCTION     133 2.751866 2.693434
    ## LO-REDUCTION     135 2.737558 2.689258
    ## HI-REDUCTION     137 2.727985 2.689258
    ## REFLECTION       139 2.701878 2.687545
    ## HI-REDUCTION     141 2.698562 2.687545
    ## EXTENSION        143 2.693434 2.672453
    ## LO-REDUCTION     145 2.689258 2.672453
    ## HI-REDUCTION     147 2.688305 2.672453
    ## REFLECTION       149 2.687545 2.671360
    ## LO-REDUCTION     151 2.678653 2.671234
    ## LO-REDUCTION     153 2.677202 2.671234
    ## LO-REDUCTION     155 2.672453 2.669443
    ## REFLECTION       157 2.671957 2.668874
    ## EXTENSION        159 2.671360 2.664198
    ## LO-REDUCTION     161 2.671234 2.664198
    ## LO-REDUCTION     163 2.669443 2.664198
    ## LO-REDUCTION     165 2.668874 2.664198
    ## EXTENSION        167 2.665928 2.660559
    ## LO-REDUCTION     169 2.665757 2.660559
    ## LO-REDUCTION     171 2.665694 2.660559
    ## LO-REDUCTION     173 2.664198 2.660559
    ## EXTENSION        175 2.663325 2.659221
    ## LO-REDUCTION     177 2.662216 2.659221
    ## EXTENSION        179 2.660746 2.656901
    ## LO-REDUCTION     181 2.660559 2.656901
    ## LO-REDUCTION     183 2.659877 2.656901
    ## LO-REDUCTION     185 2.659221 2.656901
    ## LO-REDUCTION     187 2.658891 2.656901
    ## LO-REDUCTION     189 2.658751 2.656901
    ## REFLECTION       191 2.657613 2.656485
    ## EXTENSION        193 2.657537 2.656173
    ## EXTENSION        195 2.657358 2.654759
    ## LO-REDUCTION     197 2.656901 2.654759
    ## EXTENSION        199 2.656485 2.653605
    ## LO-REDUCTION     201 2.656173 2.653605
    ## REFLECTION       203 2.655771 2.653585
    ## EXTENSION        205 2.654759 2.650066
    ## LO-REDUCTION     207 2.654204 2.650066
    ## LO-REDUCTION     209 2.653605 2.650066
    ## EXTENSION        211 2.653585 2.649658
    ## EXTENSION        213 2.651626 2.647190
    ## EXTENSION        215 2.651291 2.646294
    ## REFLECTION       217 2.650066 2.645248
    ## HI-REDUCTION     219 2.649658 2.645248
    ## EXTENSION        221 2.647271 2.643016
    ## LO-REDUCTION     223 2.647190 2.643016
    ## REFLECTION       225 2.646294 2.642659
    ## REFLECTION       227 2.645248 2.642543
    ## HI-REDUCTION     229 2.644502 2.642543
    ## EXTENSION        231 2.643241 2.638439
    ## LO-REDUCTION     233 2.643016 2.638439
    ## LO-REDUCTION     235 2.642659 2.638439
    ## LO-REDUCTION     237 2.642543 2.638439
    ## EXTENSION        239 2.640521 2.636549
    ## LO-REDUCTION     241 2.639803 2.636549
    ## EXTENSION        243 2.639735 2.634939
    ## LO-REDUCTION     245 2.638439 2.634939
    ## LO-REDUCTION     247 2.637053 2.634939
    ## LO-REDUCTION     249 2.636549 2.634731
    ## REFLECTION       251 2.635325 2.634342
    ## LO-REDUCTION     253 2.634981 2.634342
    ## HI-REDUCTION     255 2.634939 2.634342
    ## LO-REDUCTION     257 2.634731 2.634303
    ## LO-REDUCTION     259 2.634401 2.634204
    ## HI-REDUCTION     261 2.634367 2.634204
    ## REFLECTION       263 2.634342 2.634179
    ## HI-REDUCTION     265 2.634303 2.634179
    ## LO-REDUCTION     267 2.634239 2.634179
    ## HI-REDUCTION     269 2.634207 2.634179
    ## REFLECTION       271 2.634204 2.634153
    ## HI-REDUCTION     273 2.634203 2.634153
    ## LO-REDUCTION     275 2.634185 2.634153
    ## LO-REDUCTION     277 2.634179 2.634153
    ## LO-REDUCTION     279 2.634169 2.634153
    ## HI-REDUCTION     281 2.634165 2.634153
    ## Exiting from Nelder Mead minimizer
    ##     283 function evaluations used

Results

    exp(fit1$par)

    ## [1]    2.69551 2267.90270 3077.24294 1316.95126

    exp(fit2$par)

    ##      DENCL      DENVC    DENVMAX      DENVP 
    ##    2.69575 2267.08848 3078.27709 1318.52305

    as.numeric(param(mod))[names(theta)]

    ##   DENCL   DENVC DENVMAX   DENVP 
    ##    2.75 2340.00 3110.00 1324.00
